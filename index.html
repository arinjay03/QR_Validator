<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fast QR Scanner</title>

  <!-- html5-qrcode (fast client scanning) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f7f9fc; color:#0b1220; padding:18px; text-align:center; }
    #reader { width:92vw; max-width:520px; margin:14px auto; border-radius:12px; overflow:hidden; border:2px solid #e2e6ee; }
    #status{margin-top:12px;padding:10px 14px;border-radius:10px;display:inline-block;min-width:320px;font-weight:700}
    .success{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
    .error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .duplicate{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}
    button{padding:10px 14px;border-radius:10px;border:0;background:#0b1220;color:#fff;cursor:pointer}
    button.secondary{background:#e5e7eb;color:#0b1220}
    #counter{font-size:18px;margin:8px 0 0}
    .muted{color:#666;font-size:12px;margin-top:6px}
    table { margin: 10px auto; border-collapse: collapse; width: 90%; max-width: 900px; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align:left; }
    th { background:#f0f3f7; }
  </style>
</head>
<body>
  <h2>Fast QR Scanner</h2>
  <div id="counter">Total Scans: <b id="totalCount">0</b> ‚Ä¢ Device: <span id="deviceTag"></span></div>

  <div id="reader"></div>

  <div id="status">Initializing‚Ä¶</div>

  <div class="row">
    <button id="downloadBtn" class="secondary">‚¨áÔ∏è Download CSV (Local)</button>
    <button id="showTableBtn" class="secondary">üìÑ Show Recent Scans</button>
    <button id="clearBtn" class="secondary">üßπ Clear Local Scans</button>
  </div>

 

  <!-- sounds -->
  <audio id="soundValid" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="soundDup"   src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="soundInvalid" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <!-- Recent Scan table container -->
  <div id="tableContainer" style="display:none;margin-top:12px"></div>

<script>
/* ============================
   CONFIG - REPLACE THESE
   ============================
   - MASTER_JSON_URL: raw GitHub URL for your masterlist.json
         e.g. "https://raw.githubusercontent.com/<username>/<repo>/main/data/masterlist.json"
   - GAS_WEBAPP_URL: your Google Apps Script Web App URL (deployed as Web App, "Anyone")
         e.g. "https://script.google.com/macros/s/AKfycbx.../exec"
   - BACKUP_INTERVAL_MS: how often to send unsynced scans to backend (3000 ms default)
*/
const MASTER_JSON_URL = "https://raw.githubusercontent.com/arinjay03/QR_Validator/refs/heads/main/MasterQRList.json";
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxJOu4C2aYp3JcffKIIFAY26hJLTizVc2xPolW9lKzAaoOSzey_4deYJF6fy283fXNi0Q/exec"; // <-- REPLACE with your Apps Script URL
const BACKUP_INTERVAL_MS = 3000;

/* ============================
   GLOBAL STATE
   ============================ */
let deviceTag = prompt("Enter a name for this device/handset:", "Device-1");

// If user cancels or leaves blank, fallback to random ID
if(!deviceTag || deviceTag.trim() === ""){
    deviceTag = 'dev-' + Math.random().toString(36).slice(2,8);
}

// Update the UI
document.getElementById('deviceTag').textContent = deviceTag;

const statusEl = document.getElementById('status');
const totalEl  = document.getElementById('totalCount');
const soundValid = document.getElementById('soundValid');
const soundDup = document.getElementById('soundDup');
const soundInvalid = document.getElementById('soundInvalid');

let html5QrCode = null;
let masterSet = new Set();      // allowed codes loaded from MASTER_JSON_URL
// scannedRecords: array of { id, qr, tsISO, status, synced:Boolean, device }
let scannedRecords = JSON.parse(localStorage.getItem('scannedRecords_v1') || "[]");

/* helper to persist */
function persistLocalRecords(){
  localStorage.setItem('scannedRecords_v1', JSON.stringify(scannedRecords));
}

/* update UI count */
function updateCountUI(){
  totalEl.textContent = scannedRecords.length;
}

/* find if QR already scanned locally */
function alreadyScannedLocally(qr){
  return scannedRecords.some(r => r.qr === qr);
}

/* add new local record */
function addLocalRecord(qr, status){
  const rec = {
    id: (Date.now() + '-' + Math.random().toString(36).slice(2,6)),
    qr: qr,
    tsISO: (new Date()).toISOString(),
    status: status, // "Valid" | "Invalid" | "Already"
    synced: false,
    device: deviceTag
  };
  scannedRecords.push(rec);
  persistLocalRecords();
  updateCountUI();
  return rec;
}

/* ============================
   MASTER LIST LOADING (once)
   ============================ */
async function loadMasterList(){
  setStatus('‚¨áÔ∏è Loading masterlist from GitHub‚Ä¶');
  try{
    const r = await fetch(MASTER_JSON_URL, {cache: "no-store"});
    if(!r.ok) throw new Error('Failed to fetch master JSON: ' + r.status);
    const j = await r.json();
    // support two possibilities:
    // 1) master JSON is an array of strings: ["QR1","QR2"...]
    // 2) master JSON is array of objects with field `qr` or `qrCode` (we pick first)
    if(Array.isArray(j) && j.length){
      if(typeof j[0] === 'string'){
        j.forEach(s => masterSet.add(String(s).trim()));
      } else if (typeof j[0] === 'object'){
        j.forEach(o => {
          const c = o.qr || o.qrCode || o.code || Object.values(o)[0];
          if(c) masterSet.add(String(c).trim());
        });
      }
    }
    setStatus('‚úÖ Masterlist loaded: ' + masterSet.size + ' codes', 'success');
  }catch(err){
    console.error(err);
    setStatus('‚ùå Masterlist load failed: ' + (err.message || err), 'error');
  }
}

/* ============================
   SCANNER (html5-qrcode)
   ============================ */
async function startCamera(){
  if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
  try{
    const cameras = await Html5Qrcode.getCameras();
    if(!cameras || cameras.length === 0) throw new Error('No camera found');
    const back = cameras.find(c => /back|rear|environment/i.test(c.label));
    const camId = (back && back.id) || cameras[0].id;
    await html5QrCode.start(
      camId,
      { fps: 12, qrbox: { width: 300, height: 300 } },
      (decoded) => handleScan(decoded),
      (err) => { /* ignore scan errors */ }
    );
    setStatus('üì∑ Camera started ‚Äî waiting for scan‚Ä¶');
  }catch(err){
    console.error('camera', err);
    setStatus('‚ùå Camera failed ‚Äî allow permission & use HTTPS', 'error');
  }
}

/* scan handler (fast local checks first) */
async function handleScan(decodedText){
  try{ await html5QrCode.stop(); } catch(_){}
  const qr = String(decodedText).trim();
  if(!qr){
    setStatus('‚ùå Empty QR', 'error');
    soundInvalid.play();
    setTimeout(startCamera, 600);
    return;
  }

  // 1) quick local master check (in-memory)
  if(!masterSet.has(qr)){
    setStatus('‚ùå Invalid QR: ' + qr, 'error');
    soundInvalid.play();
    
    setTimeout(startCamera, 700);
    return;
  }

  // 2) local duplicate check
  if(alreadyScannedLocally(qr)){
    setStatus('‚ö†Ô∏è Already scanned (local): ' + qr, 'duplicate');
    soundDup.play();
    
    setTimeout(startCamera, 700);
    return;
  }

  // 3) valid new scan ‚Äî store locally (synced: false) and notify UI quickly
  const rec = addLocalRecord(qr, 'Valid');
  setStatus('‚úÖ Scanned (valid): ' + qr, 'success');
  soundValid.play();

  // restart camera quickly
  setTimeout(startCamera, 400);
}

/* ============================
   BACKGROUND SYNC to Google Sheets via Apps Script
   - Sends only unsynced records every BACKUP_INTERVAL_MS
   - Marks records as synced on success
   ============================ */
let isSyncInProgress = false;
async function syncToBackend(){
  if(!GAS_URL_OK()) return; // don't attempt until GAS URL is set
  if(isSyncInProgress) return;
  const unsynced = scannedRecords.filter(r => !r.synced);
  if(unsynced.length === 0) return;
  isSyncInProgress = true;
  try{
    const payload = { device: deviceTag, records: unsynced };
    const res = await fetch(GAS_WEBAPP_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' },
    });
    const j = await res.json();
    if(j && j.status === 'ok' && Array.isArray(j.ids)){
      // j.ids contains ids of records accepted by backend; mark them as synced
      const accepted = new Set(j.ids);
      let changed = false;
      scannedRecords = scannedRecords.map(r => {
        if(!r.synced && accepted.has(r.id)){
          r.synced = true;
          changed = true;
        }
        return r;
      });
      if(changed){
        persistLocalRecords();
	renderTable();
      }
    } else {
      console.warn('Backend returned unexpected response', j);
    }
  }catch(err){
    console.warn('Sync failed', err);
  } finally {
    isSyncInProgress = false;
  }
}

/* helper: check GAS URL placeholder */
function GAS_URL_OK(){
  if(!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes('AKfycbxJOu4C2aYp3JcffKIIFAY26hJLTizVc2xPolW9lKzAaoOSzey_4deYJF6fy283fXNi0Q')){
    // don't attempt
    return false;
  }
  return true;
}

/* start periodic sync */
setInterval(() => {
  syncToBackend();
}, BACKUP_INTERVAL_MS);

/* ============================
   CSV Download (from local records)
   ============================ */
function downloadLocalCSV(){
  if(scannedRecords.length === 0){ alert('No scans yet'); return; }
  const rows = [['Timestamp','QR Code','Status','Device','Synced']];
  scannedRecords.forEach(r => rows.push([r.tsISO, r.qr, r.status, r.device || '', r.synced ? 'yes' : 'no']));
  const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `scanned_local_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ============================
   UI: show recent scans table
   ============================ */
function renderTable(){
  const container = document.getElementById('tableContainer');
  if(container.style.display === 'none'){
    // show
    container.style.display = 'block';
    if(scannedRecords.length === 0){
      container.innerHTML = '<p>No scans yet.</p>';
      return;
    }
    const rows = scannedRecords.slice().reverse().slice(0,200) // show latest 200
      .map(r => `<tr><td>${r.tsISO}</td><td>${r.qr}</td><td>${r.status}</td><td>${r.device||''}</td><td>${r.synced? 'yes':'no'}</td></tr>`)
      .join('');
    container.innerHTML = `<table><thead><tr><th>Timestamp</th><th>QR Code</th><th>Status</th><th>Device</th><th>Synced</th></tr></thead><tbody>${rows}</tbody></table>`;
  } else {
    container.style.display = 'none';
  }
}

/* ============================
   Clear local scans (keeps backend intact)
   ============================ */
function clearLocal(){
  if(!confirm('Clear local scanned records? This will NOT remove entries already backed up to Google Sheets.')) return;
  scannedRecords = [];
  persistLocalRecords();
  updateCountUI();
  setStatus('Local scanned records cleared.');
}

/* ============================
   Small helpers
   ============================ */
function setStatus(msg, cls){
  statusEl.textContent = msg;
  statusEl.className = '';
  if(cls) statusEl.classList.add(cls);
}

/* ============================
   Boot flow
   ============================ */
(async function boot(){
  try{
    setStatus('‚öôÔ∏è Loading master list‚Ä¶');
    await loadMasterList();

    // Update UI from local
    updateCountUI();

    // Start camera
    await startCamera();

    // kick off an initial sync attempt (if GAS URL set)
    setTimeout(syncToBackend, 1200);
  }catch(e){
    console.error('Boot failed', e);
    setStatus('‚ùå Boot failed: ' + (e.message || e), 'error');
  }
})();

/* ============================
   UI bindings
   ============================ */
document.getElementById('downloadBtn').addEventListener('click', downloadLocalCSV);
document.getElementById('showTableBtn').addEventListener('click', renderTable);
document.getElementById('clearBtn').addEventListener('click', clearLocal);

</script>
</body>
</html>





